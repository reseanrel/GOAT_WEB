{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Burger Menu Button (Mobile) -->
    <button class="burger-menu d-md-none" id="burgerMenu">
        <i class="fas fa-bars"></i>
    </button>

    <div class="row g-0">
        {% include "admin/sidebar.html" %}

        <!-- Main Content -->
        <div class="col-md-10 main-content-wrapper">
            <div class="main-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3>Lost Pets Management</h3>
                        <p class="text-muted mb-0">Manage lost pet reports and comments</p>
                    </div>
                    <div class="text-end">
                        <h6 class="mb-0">{{ session.user_name }}</h6>
                        <span class="badge bg-danger">Administrator</span>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Lost Pets</h6>
                            <h3 class="text-danger">{{ lost_pets|length }}</h3>
                            <small class="text-muted">Active Reports</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h6><i class="fas fa-comments me-2"></i>Total Comments</h6>
                            <h3 class="text-info">{{ total_comments }}</h3>
                            <small class="text-muted">All Comments</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h6><i class="fas fa-clock me-2"></i>Recent Reports</h6>
                            <h3 class="text-warning">{{ recent_reports }}</h3>
                            <small class="text-muted">Last 7 Days</small>
                        </div>
                    </div>
                </div>

                <!-- Lost Pets List -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Lost Pets Reports</h5>
                        <p class="text-muted mb-0">Manage lost pet reports, comments, and owner communications</p>
                    </div>
                    <div class="card-body">
                        {% if lost_pets %}
                            <div class="row">
                                {% for pet in lost_pets %}
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100 border-warning">
                                        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">
                                                <i class="fas fa-paw me-2"></i>{{ pet.name }}
                                            </h6>
                                            <button class="btn btn-sm btn-success mark-found-btn" data-pet-id="{{ pet.id }}" data-pet-name="{{ pet.name }}">
                                                <i class="fas fa-check me-2"></i>Mark Found
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-12">
                                                    <table class="table table-sm table-borderless">
                                                        <tr>
                                                            <td><strong>Category:</strong></td>
                                                            <td>{{ pet.category }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td><strong>Type:</strong></td>
                                                            <td>{{ pet.pet_type or 'Not specified' }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td><strong>Age:</strong></td>
                                                            <td>{{ pet.age }} year(s)</td>
                                                        </tr>
                                                        <tr>
                                                            <td><strong>Color:</strong></td>
                                                            <td>{{ pet.color or 'Not specified' }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td><strong>Reported:</strong></td>
                                                            <td>{{ pet.registered_on.strftime('%m/%d/%Y') }}</td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-footer">
                                            <h6 class="text-primary mb-2"><i class="fas fa-user me-2"></i>Owner Information</h6>
                                            <div class="small mb-2">
                                                <p class="mb-1"><strong>Name:</strong> {{ pet.owner_name }}</p>
                                                {% if pet.owner_email %}
                                                <p class="mb-1"><strong>Email:</strong> {{ pet.owner_email }}</p>
                                                {% endif %}
                                                {% if pet.owner_contact %}
                                                <p class="mb-1"><strong>Contact:</strong> {{ pet.owner_contact }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="btn-group btn-group-sm w-100 mb-3" role="group">
                                                <button class="btn btn-outline-primary contact-email-btn" data-email="{{ pet.owner_email }}" data-owner="{{ pet.owner_name }}" data-pet="{{ pet.name }}">
                                                    <i class="fas fa-envelope me-1"></i>Email
                                                </button>
                                                {% if pet.owner_contact %}
                                                <button class="btn btn-outline-success contact-call-btn" data-contact="{{ pet.owner_contact }}">
                                                    <i class="fas fa-phone me-1"></i>Call
                                                </button>
                                                {% endif %}
                                            </div>

                                            <!-- Comments Section -->
                                            <h6 class="text-info mb-2"><i class="fas fa-comments me-2"></i>Comments & Reports</h6>
                                            {% if pet.comments %}
                                                <div class="comments-list mb-3" style="max-height: 200px; overflow-y: auto;">
                                                    {% for comment in pet.comments %}
                                                    <div class="comment-item border-start ps-2 mb-2">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div class="small flex-grow-1">
                                                                <strong>{{ comment.commenter_name or 'Anonymous' }}</strong>
                                                                {% if comment.is_admin_reply %}
                                                                <span class="badge bg-primary ms-1">Admin</span>
                                                                {% endif %}
                                                                <br>
                                                                <span class="text-muted">{{ comment.created_at.strftime('%m/%d/%Y %H:%M') }}</span>
                                                            </div>
                                                            <div class="btn-group btn-group-xs">
                                                                <button class="btn btn-xs btn-outline-success approve-comment-btn" data-comment-id="{{ comment.id }}" title="Approve">
                                                                    <i class="fas fa-check"></i>
                                                                </button>
                                                                <button class="btn btn-xs btn-outline-danger delete-comment-btn" data-comment-id="{{ comment.id }}" title="Delete">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <p class="mb-1 small">{{ comment.comment }}</p>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <p class="text-muted small mb-2">No comments yet</p>
                                            {% endif %}

                                            <!-- Admin Reply Form -->
                                            <form class="admin-reply-form" data-pet-id="{{ pet.id }}">
                                                <div class="input-group input-group-sm">
                                                    <input type="text" class="form-control" placeholder="Add admin reply..." maxlength="500" required>
                                                    <button class="btn btn-outline-info btn-sm" type="submit">
                                                        <i class="fas fa-reply"></i>
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-heart fa-4x text-success mb-3"></i>
                                <h5>No Lost Pets</h5>
                                <p class="text-muted">Great news! There are currently no active lost pet reports.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mark as Found Modal -->
<div class="modal fade" id="markFoundModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mark Pet as Found</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Mark <strong id="foundPetName"></strong> as found?</p>
                <div class="mb-3">
                    <label for="adminNote" class="form-label">Internal Note (optional)</label>
                    <textarea class="form-control" id="adminNote" rows="3" placeholder="Add any internal notes about how the pet was found..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmFound">Mark as Found</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const burgerMenu = document.getElementById('burgerMenu');
    const closeSidebar = document.getElementById('closeSidebar');
    const sidebar = document.getElementById('sidebar');

    // Toggle sidebar on burger menu click
    burgerMenu.addEventListener('click', function() {
        sidebar.classList.toggle('sidebar-open');
    });

    // Close sidebar on close button click
    closeSidebar.addEventListener('click', function() {
        sidebar.classList.remove('sidebar-open');
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
        if (window.innerWidth < 768) {
            if (!sidebar.contains(event.target) && !burgerMenu.contains(event.target)) {
                sidebar.classList.remove('sidebar-open');
            }
        }
    });

    // Contact owner functions
    document.querySelectorAll('.contact-email-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const email = this.getAttribute('data-email');
            const ownerName = this.getAttribute('data-owner');
            const petName = this.getAttribute('data-pet');
            const subject = encodeURIComponent(`Update on your lost pet: ${petName}`);
            const body = encodeURIComponent(`Dear ${ownerName},\n\nWe have an update regarding your lost pet ${petName}.\n\nBest regards,\nPila Pets Administration`);
            window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
        });
    });

    document.querySelectorAll('.contact-call-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const contact = this.getAttribute('data-contact');
            window.location.href = `tel:${contact}`;
        });
    });

    // Mark as found functionality
    document.querySelectorAll('.mark-found-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const petId = this.getAttribute('data-pet-id');
            const petName = this.getAttribute('data-pet-name');
            document.getElementById('foundPetName').textContent = petName;
            document.getElementById('adminNote').value = '';
            document.getElementById('confirmFound').setAttribute('data-pet-id', petId);
            new bootstrap.Modal(document.getElementById('markFoundModal')).show();
        });
    });

    document.getElementById('confirmFound').addEventListener('click', function() {
        const petId = this.getAttribute('data-pet-id');
        const note = document.getElementById('adminNote').value.trim();

        fetch(`/admin/mark-pet-found/${petId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ note: note })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Pet marked as found successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while marking the pet as found.');
        });
    });

    // Admin reply functionality
    document.querySelectorAll('.admin-reply-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const petId = this.getAttribute('data-pet-id');
            const replyInput = this.querySelector('input[type="text"]');
            const reply = replyInput.value.trim();

            if (!reply) {
                alert('Please enter a reply.');
                return;
            }

            // Disable form while submitting
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            fetch(`/admin/lost-pet/${petId}/reply`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reply: reply })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear the input
                    replyInput.value = '';
                    // Reload the page to show the new reply
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the reply.');
            })
            .finally(() => {
                // Re-enable form
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    });

    // Comment moderation
    document.querySelectorAll('.approve-comment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            fetch(`/admin/approve-comment/${commentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Comment approved!');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while approving the comment.');
            });
        });
    });

    document.querySelectorAll('.delete-comment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            if (confirm('Are you sure you want to delete this comment?')) {
                fetch(`/admin/delete-comment/${commentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Comment deleted!');
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the comment.');
                });
            }
        });
    });
});

function confirmLogout() {
    var logoutModal = new bootstrap.Modal(document.getElementById('logoutModal'));
    logoutModal.show();
}
</script>
{% endblock %}
