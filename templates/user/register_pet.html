{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <div class="row g-0">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar">
            <div class="sidebar-header">
                <h4><i class="fas fa-paw me-2"></i>Pila Pets</h4>
                <p class="mb-0">Municipality of Pila, Laguna</p>
            </div>
            <nav class="sidebar-nav">
                <a href="{{ url_for('user_dashboard') }}" class="nav-link">
                    <i class="fas fa-home me-2"></i>Dashboard
                </a>
                <a href="{{ url_for('adoption') }}" class="nav-link">
                    <i class="fas fa-heart me-2"></i>Adoption
                </a>
                <a href="{{ url_for('lost_pets') }}" class="nav-link">
                    <i class="fas fa-search me-2"></i>Lost Pets
                </a>
                <a href="#" onclick="confirmLogout()" class="nav-link">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <div class="main-content">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">Register New Pet</h3>
                    <a href="{{ url_for('user_dashboard') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Back
                    </a>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="card-title text-primary mb-4">Pet Registration</h5>

                        {% if errors %}
                        <div class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Please complete the required fields:</strong>
                            <ul class="mb-0 mt-2">
                                {% for field, message in errors.items() %}
                                <li>{{ message }}</li>
                                {% endfor %}
                            </ul>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endif %}

                        <form method="POST" enctype="multipart/form-data">
                            <!-- Enhanced Photo Upload Section with Drag-and-Drop -->
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-camera text-muted me-2"></i>
                                    <h6 class="mb-0 text-muted">Pet Photos (Optional)</h6>
                                </div>

                                <!-- Drag and Drop Zone -->
                                <div id="drop-zone" class="border rounded-3 p-4 text-center bg-light position-relative"
                                     style="min-height: 150px; border: 2px dashed #dee2e6;">
                                    <input type="file" name="pet_photos" id="pet_photos" class="d-none" accept="image/*" multiple>
                                    <div class="upload-area">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                        <p class="mb-1 fw-semibold text-muted">Drag & drop photos here</p>
                                        <p class="mb-0 small text-muted">or click to browse files</p>
                                        <p class="mb-0 small text-muted mt-2">PNG, JPG, JPEG, GIF • Max 16MB each • Max 10 photos</p>
                                    </div>
                                    <!-- Progress indicator (hidden by default) -->
                                    <div id="upload-progress" class="progress mt-3 d-none" style="height: 4px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>

                                <!-- File Validation Messages -->
                                <div id="file-validation" class="mt-2 d-none">
                                    <div class="alert alert-info small p-2 mb-0">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span id="validation-message">All files are valid and ready for upload</span>
                                    </div>
                                </div>

                                <!-- Photos Preview Grid -->
                                <div id="photos-preview" class="row mt-3 g-2"></div>
                            </div>

                            <!-- Basic Information Section -->
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-info-circle text-primary me-2"></i>
                                    <h6 class="mb-0">Basic Information</h6>
                                </div>
                                <div class="card border-light mb-3">
                                    <div class="card-body p-3">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label fw-semibold small">Pet Name <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control form-control-sm {% if errors and 'pet_name' in errors %}is-invalid{% endif %}"
                                                       name="pet_name" placeholder="Enter pet name"
                                                       value="{{ form_data.get('pet_name') if form_data else '' }}" required>
                                                {% if errors and 'pet_name' in errors %}
                                                <div class="invalid-feedback small">
                                                    {{ errors['pet_name'] }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-semibold small">Pet Category <span class="text-danger">*</span></label>
                                                <select class="form-select form-select-sm {% if errors and 'pet_category' in errors %}is-invalid{% endif %}"
                                                        name="pet_category" required>
                                                    <option value="">Select Category</option>
                                                    <option value="Dog" {% if form_data and form_data.get('pet_category') == 'Dog' %}selected{% endif %}>Dog</option>
                                                    <option value="Cat" {% if form_data and form_data.get('pet_category') == 'Cat' %}selected{% endif %}>Cat</option>
                                                    <option value="Bird" {% if form_data and form_data.get('pet_category') == 'Bird' %}selected{% endif %}>Bird</option>
                                                    <option value="Rabbit" {% if form_data and form_data.get('pet_category') == 'Rabbit' %}selected{% endif %}>Rabbit</option>
                                                    <option value="Other" {% if form_data and form_data.get('pet_category') == 'Other' %}selected{% endif %}>Other</option>
                                                </select>
                                                {% if errors and 'pet_category' in errors %}
                                                <div class="invalid-feedback small">
                                                    {{ errors['pet_category'] }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-semibold small">Breed/Type</label>
                                                <input type="text" class="form-control form-control-sm" name="pet_type"
                                                       placeholder="e.g., Aspin, Persian" value="{{ form_data.get('pet_type') if form_data else '' }}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-semibold small">Age (years)</label>
                                                <input type="number" class="form-control form-control-sm" name="age"
                                                       placeholder="Age" min="0" max="50" value="{{ form_data.get('age') if form_data else '' }}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-semibold small">Color</label>
                                                <input type="text" class="form-control form-control-sm" name="color"
                                                       placeholder="e.g., Black, White" value="{{ form_data.get('color') if form_data else '' }}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-semibold small">Gender</label>
                                                <select class="form-select form-select-sm" name="gender">
                                                    <option value="">Select Gender</option>
                                                    <option value="Male" {% if form_data and form_data.get('gender') == 'Male' %}selected{% endif %}>Male</option>
                                                    <option value="Female" {% if form_data and form_data.get('gender') == 'Female' %}selected{% endif %}>Female</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" name="for_adoption" id="for_adoption"
                                           {% if form_data and form_data.get('for_adoption') == 'on' %}checked{% endif %}>
                                    <label class="form-check-label small" for="for_adoption">
                                        Available for Adoption
                                    </label>
                                </div>
                            </div>

                            <!-- Owner Information Section -->
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-user text-primary me-2"></i>
                                    <h6 class="mb-0">Owner Information</h6>
                                </div>
                                <div class="card border-light">
                                    <div class="card-body p-3">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label fw-semibold small">Name</label>
                                                    <input type="text" class="form-control form-control-sm" value="{{ session.user_name }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label fw-semibold small">Email</label>
                                                    <input type="email" class="form-control form-control-sm" value="{{ session.user_email }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label class="form-label fw-semibold small">Address</label>
                                                    <input type="text" class="form-control form-control-sm" value="{{ session.user_address if session.user_address else 'Not provided' }}" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="d-flex justify-content-end gap-2 mt-4">
                                <a href="{{ url_for('user_dashboard') }}" class="btn btn-outline-secondary btn-sm px-3">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-primary btn-sm px-4">
                                    <i class="fas fa-paw me-1"></i> Register Pet
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom styles for the modern form */
.cursor-pointer {
    cursor: pointer;
}

.form-control-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.form-select-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.card {
    border: 1px solid #e0e0e0;
    border-radius: 0.5rem;
}

.card-title {
    font-weight: 600;
    color: #2c3e50;
}

.fw-semibold {
    font-weight: 500 !important;
}

.small {
    font-size: 0.875rem !important;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.btn-primary {
    background-color: #3498db;
    border-color: #3498db;
}

.btn-outline-secondary {
    color: #6c757d;
    border-color: #dee2e6;
}

.btn-outline-secondary:hover {
    color: #fff;
    background-color: #6c757d;
    border-color: #6c757d;
}

/* Photo preview styling */
#photos-preview .col-md-3 {
    position: relative;
}

#photos-preview img {
    width: 100%;
    height: 80px;
    object-fit: cover;
    border-radius: 0.25rem;
}

#photos-preview .btn-sm {
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    padding: 0.125rem 0.25rem;
    font-size: 0.75rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .sidebar {
        display: none;
    }

    .main-content {
        padding: 1rem;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
    }
}
</style>

<script>
// Enhanced Photo Upload with Drag-and-Drop, Real-time Preview, and Validation
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('pet_photos');
    const previewContainer = document.getElementById('photos-preview');
    const progressBar = document.querySelector('.progress-bar');
    const validationArea = document.getElementById('file-validation');
    const validationMessage = document.getElementById('validation-message');

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    // Highlight drop zone when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    // Handle dropped files
    dropZone.addEventListener('drop', handleDrop, false);

    // Handle file selection via click
    fileInput.addEventListener('change', handleFiles, false);

    // Click on drop zone triggers file input
    dropZone.addEventListener('click', function() {
        fileInput.click();
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight() {
        dropZone.style.borderColor = '#3498db';
        dropZone.style.backgroundColor = '#f8f9fa';
    }

    function unhighlight() {
        dropZone.style.borderColor = '#dee2e6';
        dropZone.style.backgroundColor = '#f8f9fa';
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles({ target: { files: files } });
    }

    function handleFiles(e) {
        const files = e.target.files;

        // Show progress bar
        progressBar.style.width = '0%';
        document.getElementById('upload-progress').classList.remove('d-none');

        // Simulate progress (in real app, this would be actual upload progress)
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            progressBar.style.width = `${progress}%`;

            if (progress >= 100) {
                clearInterval(progressInterval);
                setTimeout(() => {
                    document.getElementById('upload-progress').classList.add('d-none');
                }, 500);
            }
        }, 50);

        // Validate files
        const validation = validateFiles(files);
        if (validation.valid) {
            showValidationMessage('success', validation.message);
            previewFiles(files);
        } else {
            showValidationMessage('error', validation.message);
            // Clear file input if invalid
            fileInput.value = '';
            previewContainer.innerHTML = '';
        }
    }

    function validateFiles(files) {
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
        const maxSize = 16 * 1024 * 1024; // 16MB
        const maxFiles = 10;

        if (files.length === 0) {
            return { valid: true, message: 'No files selected' };
        }

        if (files.length > maxFiles) {
            return { valid: false, message: `Maximum ${maxFiles} files allowed` };
        }

        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            if (!allowedTypes.includes(file.type)) {
                return { valid: false, message: `File ${file.name} is not a valid image (PNG, JPG, JPEG, GIF only)` };
            }

            if (file.size > maxSize) {
                return { valid: false, message: `File ${file.name} exceeds maximum size of 16MB` };
            }
        }

        return { valid: true, message: `${files.length} file(s) selected - all valid and ready for upload` };
    }

    function showValidationMessage(type, message) {
        validationMessage.textContent = message;

        // Update alert class based on type
        const alert = validationArea.querySelector('.alert');
        alert.classList.remove('alert-info', 'alert-success', 'alert-warning', 'alert-danger');

        if (type === 'success') {
            alert.classList.add('alert-success');
        } else if (type === 'error') {
            alert.classList.add('alert-danger');
        } else {
            alert.classList.add('alert-info');
        }

        validationArea.classList.remove('d-none');
    }

    function previewFiles(files) {
        previewContainer.innerHTML = '';

        if (files.length === 0) {
            return;
        }

        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const col = document.createElement('div');
                col.className = 'col-md-3 col-sm-4 col-6';

                // Create preview card
                const previewCard = document.createElement('div');
                previewCard.className = 'card border-light shadow-sm h-100';

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body p-2 position-relative';

                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = `Preview ${index + 1}`;
                img.className = 'img-fluid rounded';
                img.style.height = '100px';
                img.style.objectFit = 'cover';

                const fileInfo = document.createElement('div');
                fileInfo.className = 'small text-muted mt-1 text-truncate';
                fileInfo.textContent = file.name;

                const fileSize = document.createElement('div');
                fileSize.className = 'small text-muted text-truncate';
                fileSize.textContent = formatFileSize(file.size);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-1';
                removeBtn.style.padding = '0.1rem 0.3rem';
                removeBtn.style.fontSize = '0.7rem';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = function() {
                    removePhoto(index);
                };

                cardBody.appendChild(img);
                cardBody.appendChild(fileInfo);
                cardBody.appendChild(fileSize);
                cardBody.appendChild(removeBtn);
                previewCard.appendChild(cardBody);
                col.appendChild(previewCard);

                previewContainer.appendChild(col);
            };
            reader.readAsDataURL(file);
        });
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' bytes';
        else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    window.removePhoto = function(index) {
        const dt = new DataTransfer();
        const input = document.getElementById('pet_photos');
        const files = Array.from(input.files);

        // Remove the file at the specified index
        files.splice(index, 1);

        // Add remaining files back
        files.forEach(file => dt.items.add(file));
        input.files = dt.files;

        // Update preview
        if (files.length > 0) {
            previewFiles(files);
            showValidationMessage('success', `${files.length} file(s) remaining`);
        } else {
            previewContainer.innerHTML = '';
            validationArea.classList.add('d-none');
        }
    };
});
</script>
{% endblock %}
