{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <div class="row g-0">
        {% include "user/sidebar.html" %}

        <!-- Main Content -->
        <div class="col-md-10">
            <div class="main-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Pet Adoption</h3>
                </div>

                <!-- Adoption Info Alert -->
                <div class="alert alert-info" role="alert" style="margin: 0 2rem 2rem 2rem;">
                    <h5><i class="fas fa-info-circle"></i> How Adoption Works</h5>
                    <p>Here you can browse pets available for adoption. If you're interested in adopting a pet, click "Express Interest" to send a message to the pet owner. The owner will be notified and can contact you directly.</p>
                </div>

<div style="margin: 0 2rem 2rem 2rem;">
    <div class="header">
        <div>
            <h2>Available for Adoption</h2>
            <p>Browse pets looking for their forever homes</p>
        </div>
    </div>

    <div class="pet-container">
        {% if adoption_pets %}
            {% for pet in adoption_pets %}
        <div class="pet-card">
            {% if pet.photo_url %}
            <img src="{{ url_for('static', filename='uploads/' + pet.photo_url) }}?t={{ datetime.now().timestamp() | int }}" alt="{{ pet.name }}" class="pet-img">
            {% else %}
            <img src="https://via.placeholder.com/260x200" class="pet-img">
            {% endif %}
            <div class="tag-bar">
                {% if pet.category == 'Dog' %}
                <span class="tag-dog">Dog</span>
                {% elif pet.category == 'Cat' %}
                <span class="tag-cat">Cat</span>
                {% else %}
                <span class="tag-other">{{ pet.category }}</span>
                {% endif %}
                <span class="tag-available">Available for Adoption</span>
            </div>
            <div class="details">
                <div class="pet-name">{{ pet.name }}</div>
                <p><strong>Breed:</strong> {{ pet.pet_type or 'Not specified' }}</p>
                <p><strong>Gender:</strong> {{ pet.gender or 'Not specified' }}</p>
                <p><strong>Age:</strong> {{ pet.age }} years</p>
                <p><strong>Color:</strong> {{ pet.color or 'Not specified' }}</p>
                <p><strong>Owner:</strong> {{ pet.owner_name }}</p>
                <p><strong>Listed:</strong> {{ pet.registered_on.strftime('%B %d, %Y') }}</p>

                <button type="button" class="details-btn" data-bs-toggle="modal" data-bs-target="#interestModal{{ pet.id }}">
                    <i class="fas fa-heart me-2"></i>Express Interest
                </button>
            </div>
        </div>

        <!-- Interest Modal -->
        <div class="modal fade" id="interestModal{{ pet.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-heart text-danger"></i> Express Interest in {{ pet.name }}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="interestForm{{ pet.id }}" onsubmit="submitInterest(event, {{ pet.id }})">
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <small>Your interest will be sent to the pet owner. They will receive your name, email, and message.</small>
                            </div>

                            <div class="form-group">
                                <label for="message{{ pet.id }}">Message to Owner <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="message{{ pet.id }}" name="message" rows="4" placeholder="Tell the owner why you're interested in adopting {{ pet.name }}..." required></textarea>
                            </div>

                            <div class="form-group">
                                <label for="contact{{ pet.id }}">Additional Contact (Optional)</label>
                                <input type="text" class="form-control" id="contact{{ pet.id }}" name="contact" placeholder="Phone number or other contact info">
                                <small class="form-text text-muted">This will be included in your message to the owner.</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-paper-plane"></i> Send Interest
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5" style="width: 100%;">
                <i class="fas fa-heart-broken fa-4x text-muted mb-3"></i>
                <h5>No Pets Available for Adoption</h5>
                <p class="text-muted mb-4">There are currently no pets listed for adoption. Check back later!</p>
                <a href="{{ url_for('user_dashboard') }}" class="btn btn-primary">
                    <i class="fas fa-home"></i> Back to Dashboard
                </a>
            </div>
        {% endif %}
    </div>
</div>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <span id="successMessage">Interest submitted successfully!</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>

    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorMessage">An error occurred. Please try again.</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <span id="successMessage">Interest submitted successfully!</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>

    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorMessage">An error occurred. Please try again.</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
/* global bootstrap */
function submitInterest(event, petId) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);

    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    fetch(`/express-adoption-interest/${petId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById(`interestModal${petId}`));
            modal.hide();

            // Show success toast
            showToast('success', data.message);

            // Reset form
            form.reset();
        } else {
            showToast('error', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'An error occurred. Please try again.');
    })
    .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function showToast(type, message) {
    const toastId = type === 'success' ? 'successToast' : 'errorToast';
    const messageId = type === 'success' ? 'successMessage' : 'errorMessage';

    document.getElementById(messageId).textContent = message;

    const toast = new bootstrap.Toast(document.getElementById(toastId));
    toast.show();
}

function confirmLogout() {
    var logoutModal = new bootstrap.Modal(document.getElementById('logoutModal'));
    logoutModal.show();
}
</script>
{% endblock %}
